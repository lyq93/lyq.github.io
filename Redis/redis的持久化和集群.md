## redis的持久化和集群

### 持久化

> 数据持久化出现的原因是防止服务器挂掉导致数据丢失从而进行数据备份。

- RDB

> 固定频率的对redis内存中的数据进行一次全面的扫描，把数据刷到磁盘。
>
> 这种方式的特点：
>
> 1、数据恢复快
>
> 2、数据丢失较多
>
> 因为数据是原封不动的刷到磁盘的，恢复的时候只要进行数据载入就可以了。所以速度上来说是很快的。
>
> 因为是固定频率的执行，假设每1小时执行一次，那么在redis服务器挂掉之后，新服务器起来之前，丢失了从上次备份点到当前时间的数据。

- AOF

> 这是追加日志的方式，有3个级别
>
> 1、每次操作都记录日志
>
> 由于涉及到磁盘IO，这种方式是最慢的
>
> 2、每秒记录一次
>
> redis默认开启这种方式
>
> 3、不开启
>
> 完全依赖于操作系统
>
> AOF的特点：
>
> 1、恢复速度慢
>
> 2、数据备份比较完成
>
> 由于AOF是把redis的操作命令记录到日志当中，所以数据恢复的时候需要重演redis命令，所以速度会慢。
>
> 由于AOF默认是每秒一次，也就是说数据最多丢失1秒

- RDB&AOF

> 两种方式结合使用。这就是类似于大数据里面nameNode的备份机制一样。采用RDB进行固定频率对内存进行快照，在快照的时间节点之后的操作记录到日志当中。最后数据恢复的时候也是快照+日志的方式进行恢复。
>
> 1、既比AOF快又比RDB数据备份完整
>
> 2、对于日志文件的处理，即使始终在来回处理效果一致的指令，但是日志文件是不断的累积的。在redis中会把原重复无效的指令清掉只留下有效指令，然后再在有效指令中追加。

### 集群

#### 单机

> 单机redis或者说单机的任何技术，都逃不脱两个问题：
>
> 1、单点故障问题
>
> ​	解决方案是主从备份，主从节点的数据是全量的，也就是说需要做同步操作
>
> 2、压力问题
>
> ​	分片、分治集群，节点的数据是不一样的，也就是说不需要做同步操作

#### 主从备份

> 解决单点故障问题，一个主节点提供服务，一个从节点同步主节点数据作为备份。
>
> 同步数据存在以下几种方式：
>
> 1、强一致性
>
> 客户端发送一个写请求，主节点写成功之后，发送命令给从节点服务器写，从节点也写成功的同时返回应答给主节点，这个时候主节点再返回写成功给客户端。
>
> 这种方式能保证主从节点的数据是强一致性的，但是也存在相应的问题。如果从节点挂了，主节点就拿不到从节点的应答，从而服务就不可用了。
>
> 2、弱一致性
>
> 客户端发送一个写请求，主节点写成功之后，发送命令给从节点的同时返回响应给客户端，从节点自己写成功或者失败主节点不关心了。这种方式下，如果从节点没写成功，那么主从节点的数据就存在一定的差异。当服务挂掉的时候，数据是有可能会丢失
>
> 3、最终一致
>
> 客户端发送一个写请求，主节点写成功之后，发送命令给一个中间服务（这个服务是高可用）同时响应请求，从节点做数据同步只需要向中间服务请求数据就可以了。
>
> 主节点写数据到中间服务如何算成功？采用过半机制，保证半数成功即可
>
> 从服务器去请求数据的时候，如果请求的是高版本数据（可能存在未写成功数据的服务称为低版本数据服务）的服务，那么通过服务之间的通信，发现过半的服务的数据都是这个版本，就正常响应该版本数据。如果从节点连的是低版本的数据，那么通过过半机制也不会响应该版本的数据。
>
> 这种方式来保证最终一致性。这也是很多技术都采用的一个实现

#### Cluster集群

> 解决单机或者主从的压力问题。cluster模式的核心是分片，每一个节点存放数据的一部分，这种集群一般分为三种模式：
>
> 1、由客户端实现分片，把分片后的数据分别发往不同的redis服务器中
>
> 这种方式下，客户端是笨重的，分片算法是放在客户端侧的
>
> 2、分片算法放在一个第三方服务中，客户端请求第三方服务，第三方服务分片后把数据发往不同的reids服务器。
>
> 这种方式下，客户端是轻盈的，但是中间服务是否有性能瓶颈，引入第三方服务是否可能带来其他一些技术问题等
>
> 3、redis自身携带这种分片功能，redis cluster模式下有个槽点（slot）的概念，每个节点都会分有一部分的槽点。节点之间建立起了通信，客户端可以连接任务一台服务器处理数据，如果处理的数据在别的服务器上，可以通过通信把数据写到对应的服务器上
>
> cluster模式一般跟主从节点混合使用，由于每个节点都分配部分数据，如果节点挂掉，会导致部分数据丢失。
>
> 另外，这里引出一个分布式拆分原则AKF：
>
> 以redis为例，服务的拆分有3个方向，一个是横向（复制扩展），一个是纵向（业务拆分），一个是Z轴（对于业务拆分后不可再拆的情况下，进行分片）
>
> redis的主从模式是为了防止出现单点故障的问题，各个节点的数据是全量的，这个就是横向扩展。
>
> 那么纵向拆分的话，根据redis服务中的业务数据（或者其他维度）进行拆分，使每个redis服务器持有业务独立性的相关数据
>
> Z轴就是分片，再纵向拆分后如果redis服务器的数据依然比较大，这个情况下可以使用redis的分片，把相关业务的数据切成多个服务，每个服务存放部分数据。